name: ðŸ§ Autograde Linux Lab - InskillFlow
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  autograde:
    runs-on: ubuntu-latest
    name: Ã‰valuation automatique du Lab Linux
    
    steps:
    - name: ðŸ“¥ Checkout du code Ã©tudiant
      uses: actions/checkout@v4
      
    - name: ðŸ” VÃ©rification de la structure du lab
      run: |
        echo "ðŸ” VÃ©rification de la structure des fichiers..."
        
        # VÃ©rifier que le dossier lab existe
        if [ ! -d "lab" ]; then
          echo "âŒ ERREUR: Le dossier 'lab' n'existe pas"
          echo "ðŸ’¡ Conseil: ExÃ©cutez l'exercice 3 pour crÃ©er la structure"
          exit 1
        else
          echo "âœ… Dossier 'lab' trouvÃ©"
        fi
        
        # VÃ©rifier que le fichier rapport.txt existe
        if [ ! -f "lab/rapport.txt" ]; then
          echo "âŒ ERREUR: Le fichier 'lab/rapport.txt' n'existe pas"
          echo "ðŸ’¡ Conseil: ExÃ©cutez l'exercice 3 pour crÃ©er le rapport"
          exit 1
        else
          echo "âœ… Fichier 'lab/rapport.txt' trouvÃ©"
        fi
        
    - name: ðŸ“ VÃ©rification du contenu du rapport
      run: |
        echo "ðŸ“ VÃ©rification du contenu du rapport..."
        
        # VÃ©rifier le message de succÃ¨s
        if grep -q "Lab Linux terminÃ© avec succÃ¨s" lab/rapport.txt; then
          echo "âœ… Message de succÃ¨s trouvÃ©"
        else
          echo "âŒ ERREUR: Message de succÃ¨s manquant dans le rapport"
          exit 1
        fi
        
        # VÃ©rifier la prÃ©sence de l'utilisateur
        if grep -q "Utilisateur:" lab/rapport.txt; then
          echo "âœ… Information utilisateur prÃ©sente"
        else
          echo "âŒ ERREUR: Information utilisateur manquante"
          exit 1
        fi
        
        # VÃ©rifier la prÃ©sence de la date
        if grep -q "Date:" lab/rapport.txt; then
          echo "âœ… Information de date prÃ©sente"
        else
          echo "âŒ ERREUR: Information de date manquante"
          exit 1
        fi
        
    - name: ðŸ—‚ï¸ VÃ©rification de la structure des dossiers
      run: |
        echo "ðŸ—‚ï¸ VÃ©rification de la structure des dossiers..."
        
        # VÃ©rifier la hiÃ©rarchie lab/exercices/linux
        if [ -d "lab/exercices/linux" ]; then
          echo "âœ… Structure complÃ¨te lab/exercices/linux trouvÃ©e"
        elif [ -d "lab/exercices" ]; then
          echo "âš ï¸ Structure partielle lab/exercices trouvÃ©e"
        else
          echo "â„¹ï¸ Structure minimale (dossier lab seulement)"
        fi
        
    - name: ðŸ“Š Affichage du contenu du rapport
      run: |
        echo "ðŸ“Š Contenu du rapport crÃ©Ã© par l'Ã©tudiant:"
        echo "=========================================="
        cat lab/rapport.txt
        echo "=========================================="
        
    - name: ðŸŽ¯ Calcul de la note
      run: |
        echo "ðŸŽ¯ Calcul de la note du lab..."
        
        score=0
        total=100
        
        # VÃ©rification de la structure (40 points)
        if [ -d "lab" ] && [ -f "lab/rapport.txt" ]; then
          score=$((score + 40))
          echo "âœ… Structure de base: +40 points"
        fi
        
        # VÃ©rification du contenu (40 points)
        if grep -q "Lab Linux terminÃ© avec succÃ¨s" lab/rapport.txt && \
           grep -q "Utilisateur:" lab/rapport.txt && \
           grep -q "Date:" lab/rapport.txt; then
          score=$((score + 40))
          echo "âœ… Contenu du rapport: +40 points"
        fi
        
        # Bonus pour structure complÃ¨te (20 points)
        if [ -d "lab/exercices/linux" ]; then
          score=$((score + 20))
          echo "âœ… Structure complÃ¨te: +20 points (bonus)"
        elif [ -d "lab/exercices" ]; then
          score=$((score + 10))
          echo "âœ… Structure partielle: +10 points"
        fi
        
        echo "ðŸ“Š Score final: $score/$total points"
        
        # DÃ©terminer le statut
        if [ $score -ge 80 ]; then
          echo "ðŸŽ‰ EXCELLENT! Lab rÃ©ussi avec brio!"
          echo "grade=A" >> $GITHUB_ENV
        elif [ $score -ge 60 ]; then
          echo "ðŸ‘ BIEN! Lab rÃ©ussi!"
          echo "grade=B" >> $GITHUB_ENV
        elif [ $score -ge 40 ]; then
          echo "âš ï¸ PASSABLE. Quelques Ã©lÃ©ments manquants."
          echo "grade=C" >> $GITHUB_ENV
        else
          echo "âŒ INSUFFISANT. Veuillez refaire les exercices."
          echo "grade=F" >> $GITHUB_ENV
          exit 1
        fi
        
        echo "score=$score" >> $GITHUB_ENV
        
    - name: ðŸ“‹ RÃ©sumÃ© de l'Ã©valuation
      run: |
        echo "# ðŸ“‹ RÃ©sumÃ© de l'Ã©valuation - Lab Linux Basics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Score obtenu:** ${{ env.score }}/100 points" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** ${{ env.grade }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… Ã‰lÃ©ments validÃ©s" >> $GITHUB_STEP_SUMMARY
        echo "- Structure du lab crÃ©Ã©e" >> $GITHUB_STEP_SUMMARY
        echo "- Fichier rapport.txt prÃ©sent" >> $GITHUB_STEP_SUMMARY
        echo "- Contenu du rapport correct" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ Structure dÃ©tectÃ©e" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find lab -type f -o -type d | sort >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ Contenu du rapport" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        cat lab/rapport.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Lab Linux Basics terminÃ© avec succÃ¨s!**" >> $GITHUB_STEP_SUMMARY
